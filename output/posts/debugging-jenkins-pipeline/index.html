<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Debugging Jenkins pipeline | Adam Saleh's notes</title>
<link href="../../assets/css/theme.css" type="text/css" rel="stylesheet">
<link href="../../assets/css/pure.css" type="text/css" rel="stylesheet">
<link href="../../assets/css/style.css" type="text/css" rel="stylesheet">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://notes.asaleh.net/posts/debugging-jenkins-pipeline/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Adam Saleh">
<link rel="prev" href="../applicative-pattern-for-reactive-programming/" title="Applicative pattern for reactive programming" type="text/html">
<meta property="og:site_name" content="Adam Saleh's notes">
<meta property="og:title" content="Debugging Jenkins pipeline">
<meta property="og:url" content="http://notes.asaleh.net/posts/debugging-jenkins-pipeline/">
<meta property="og:description" content="Few notes on debugging a Jenkinsfile
For past few months I have been using Jenkinsfiles and Jenkins pipelines more and more.
They have many advantages to our previous setup, that over-relied on storin">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-07-30T14:18:08+02:00">
<meta property="article:tag" content="pipelines">
<meta property="article:tag" content="testing">
</head>
<body>
<div class="body_container">
    <div id="header">
        <div class="site-name">
                <a id="logo" href="http://notes.asaleh.net/"><h1>Adam Saleh's notes</h1></a>
        </div>

        <div id="nav-menu">
            <div class="bitcron_nav_container">
                <div class="bitcron_nav">
                    <div class="site_nav_wrap">
                        <ul class="site_nav sm sm-base">
<li><a href="../../pages/about/" class="nav__item">About</a></li>
            <li><a href="../../pages/algebraic-patterns/" class="nav__item">Algebraic patterns</a></li>
            <li><a href="../../archive.html" class="nav__item">Archive</a></li>
            <li><a href="../../categories/" class="nav__item">Tags</a></li>
            <li><a href="../../rss.xml" class="nav__item">RSS feed</a></li>

                            
                        </ul>
<div class="clear clear_nav_inline_end"></div>
                    </div>
                </div>
                <div class="clear clear_nav_end"></div>
            </div>
        </div>
    </div>
    <div id="layout">
        <div class="pure-g">
            <div class=" pure-u-24-24 pure-u-sm-24-24 pure-u-md-18-24 pure_cell">
                <div class="content_container">
                    <!--Body content-->
                    <div class="row">
                        
                        
<div class="post post-page">
    
    <header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Debugging Jenkins pipeline</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Adam Saleh
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2017-07-30T14:18:08+02:00" itemprop="datePublished" title="2017-07-30 14:18">2017-07-30 14:18</time></a></p>
                <p class="commentline">
        
<a href="%7Blink%7D" onclick="this.href='/posts/debugging-jenkins-pipeline/'; this.target='_self';"><span class="IDCommentsReplace" style="display:none">cache/posts/debugging-jenkins-pipeline.html</span>
<script>
var idcomments_acct = '1fb78414f6b8ffc05cf0238b6fa4e491';
var idcomments_post_id = "cache/posts/debugging-jenkins-pipeline.html";
var idcomments_post_url = "/posts/debugging-jenkins-pipeline/";
</script><script src="http://www.intensedebate.com/js/genericLinkWrapperV2.js"></script></a>


            
        </p>
<p class="sourceline"><a href="index.md" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="post-content">
        <div>
<h2>Few notes on debugging a Jenkinsfile</h2>
<p>For past few months I have been using Jenkinsfiles and Jenkins pipelines more and more.
They have many advantages to our previous setup, that over-relied on storing as much as possible
in jenkins-job-builder yaml configs and chaining builds together with post-build triggers.</p>
<p>With jenkins-files, we can use Groovy to script everything and that is much nicer than the combination of bash and yaml.
You can do code-sharing with pipeline-libraries. And all of this really nicely integrates with Github, so we now roll our
own travis-like ci in our own infrastructure.</p>
<p>On the other hand, if there is a problem, especially in longer running pipeline, it can be quite painful to debug.</p>
<h3>Stage one: thorough debug logs</h3>
<p>If the problem that I encounter is simple enough, it might be solved just by adding a few print statements here and there,
and re-running the job. This usually works as long as the run is shorter than ~5 minutes. In my case, around the 5 minute mark,
the "Read logs"-"Change code"-"Rerun" cycle starts being unbearably slow.</p>
<h3>Stage two: improvising a break-point</h3>
<p>In our infrastructure, we are using docker slaves for most things. On one hand, this means that job usually run in clean environment. Unfortunately, this also means that if something goes wrong, before I start investigating, the container my job was running on is long gone.</p>
<p>One trick that usually helped me here, was adding an "input" prompt into my jenkins file in the place I want to investigate.
This way I was able to pause the execution of the pipeline, ssh into the container and investigate further.</p>
<p><img alt="Improvised breakpoint" src="../../images/improvize_breakpoint.png"></p>
<p>Doing a naive ssh into the container can lead to one more problem. The running job often changes the environment for the commands it would run, which means that the external connection wouldn't have access to the same environmental variables, e.t.c.</p>
<p>To mitigate this, I first try to start a tmux session in the jenkins job. Then I attach inside of it.</p>
<h3>Stage three: improvising a repl</h3>
<p>Sometimes I would need to investigate reason for failure of a pipeline-command itself. In this case I would create a weird little repl-like environment:</p>
<pre class="code literal-block"><span></span>while (true) {
    def cmd = input message: 'What to run:', parameters: [string(defaultValue: '', description: '', name: 'cmd')]
    try {
        print Eval.x(this,cmd)
    } catch (e) {
        print e
    }
   }
</pre>


<p>You can then input code to execute in this case, something like:</p>
<pre class="code literal-block"><span></span>x.binding.steps.invokeMethod("sh","node --version")
</pre>


<p>The nice thing about this is, that now I have limitted access to the rest of the jenkins machinery, while in shell I'd only have access to shell commands. On the other hand, it is really crude. Especially passing in other variables is tricky, and it is even harder to save the results of execution anywhere else. As you can see, I had to use the dsl object methods directly, instead of writing in the same style as in the Jenkinsfile. </p>
<h3>To conclude, debugging Jenkinsfiles is ugly</h3>
<p>In the future I will probably invest more into the testing side of our pipelines. I know there is a <a href="https://github.com/lesfurets/JenkinsPipelineUnit">unit-testing library</a>. I should make sure that thing I actually run in the pipelines is reproducible more easily on my machine as well.</p>
<p>On the other hand, I could invest a significant ammount of time to develop a true Jenkinsfile repl. Unfortunately it seems that <em>ain't nobody got time for that</em>. But I would be quite interested in other solutions to this problem.</p>
</div>
    </div>
    <div class="postpromonav">
        <nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/pipelines/" rel="tag">pipelines</a></li>
            <li><a class="tag p-category" href="../../categories/testing/" rel="tag">testing</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../applicative-pattern-for-reactive-programming/" rel="prev" title="Applicative pattern for reactive programming">Previous post</a>
            </li>
        </ul></nav>
</div>
    <section class="comments hidden-print"><h2>Comments</h2>
        
        
<script>
var idcomments_acct = '1fb78414f6b8ffc05cf0238b6fa4e491';
var idcomments_post_id = "cache/posts/debugging-jenkins-pipeline.html";
var idcomments_post_url = "http://notes.asaleh.net/posts/debugging-jenkins-pipeline/";
</script><span id="IDCommentsPostTitle" style="display:none"></span>
<script src="http://www.intensedebate.com/js/genericCommentWrapperV2.js"></script></section>
</div>

                </div>
                <!--End of body content-->
                <div style="clear:both;height:0;"></div>
            </div>
        </div>

        <!-- Sidebar -->

        <div class=" pure-u-6-24 pure_cell">
            <div id="sidebar">
                <div class="widget">
                    <div id="search_bar">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="footer">
        Contents Â© 2017         <a href="mailto:adam@">Adam Saleh</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
        
    </div>

    <!--FIXME: put these somewhere                            -->
    <!--%if len(translations) > 1:-->
    <!--<li>
</li>-->
    <!--%endif-->
    <!--% if show_sourcelink:-->
    <!---->
    <!--%endif-->
    <link href="../../assets/css/duoshuo.css" type="text/css" rel="stylesheet">
<script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</div>
</div>
</body>
</html>
